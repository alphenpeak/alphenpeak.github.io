<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Financial Overview | Alphen Peak</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="../assets/css/styles.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
 <script>
/* ---------- Global state ---------- */
let fullData = []; 
let chartInstance = null;

/* ---------- Load data ---------- */
async function loadFinancialData() {
  const response = await fetch("data/financials.csv");
  const text = await response.text();

  const rows = text.trim().split("\n").slice(1);

  fullData = rows.map(row => {
    const [month, rev, exp] = row.split(",");
    return {
      month,
      revenue: Number(rev),
      expenses: Number(exp)
    };
  });

  populateMonthFilter();
  applyFilter("all");
}

/* ---------- Filtering ---------- */
function applyFilter(selectedMonth) {
  const filtered =
    selectedMonth === "all"
      ? fullData
      : fullData.filter(d => d.month === selectedMonth);

  const labels = filtered.map(d => d.month);
  const revenue = filtered.map(d => d.revenue);
  const expenses = filtered.map(d => d.expenses);

  updateKPIs(
    revenue.reduce((a, b) => a + b, 0),
    expenses.reduce((a, b) => a + b, 0)
  );

  renderChart(labels, revenue, expenses);
}

/* ---------- KPI update ---------- */
function updateKPIs(totalRevenue, totalExpenses) {
  const profit = totalRevenue - totalExpenses;
  const margin = totalRevenue ? (profit / totalRevenue) * 100 : 0;

  document.getElementById("kpi-revenue").textContent =
    totalRevenue.toLocaleString("en-ZA", { style: "currency", currency: "ZAR" });

  document.getElementById("kpi-expenses").textContent =
    totalExpenses.toLocaleString("en-ZA", { style: "currency", currency: "ZAR" });

  document.getElementById("kpi-profit").textContent =
    profit.toLocaleString("en-ZA", { style: "currency", currency: "ZAR" });

  document.getElementById("kpi-margin").textContent =
    margin.toFixed(1) + "%";
}

/* ---------- Chart rendering ---------- */
function renderChart(labels, revenue, expenses) {
  const ctx = document.getElementById("revenueChart").getContext("2d");

  if (chartInstance) {
    chartInstance.destroy();
  }

  chartInstance = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "Revenue",
          data: revenue,
          borderColor: "#1f3a5f",
          backgroundColor: "transparent",
          pointBackgroundColor: "#1f3a5f",
          fill: false,
          tension: 0.2
        },
        {
          label: "Expenses",
          data: expenses,
          borderColor: "#999",
          backgroundColor: "transparent",
          pointBackgroundColor: "#999",
          fill: false,
          tension: 0.2
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: "bottom",
          labels: {
            usePointStyle: true,
            generateLabels: chart =>
              chart.data.datasets.map((ds, i) => ({
                text: ds.label,
                strokeStyle: ds.borderColor,
                fillStyle: ds.borderColor,
                lineWidth: 2,
                pointStyle: "line",
                hidden: !chart.isDatasetVisible(i),
                index: i
              }))
          }
        }
      }
    }
  });
}

/* ---------- Dropdown ---------- */
function populateMonthFilter() {
  const select = document.getElementById("monthFilter");

  // prevent duplicates
  select.innerHTML = '<option value="all">All months</option>';

  fullData.forEach(d => {
    const option = document.createElement("option");
    option.value = d.month;
    option.textContent = d.month;
    select.appendChild(option);
  });

  select.addEventListener("change", e =>
    applyFilter(e.target.value)
  );
}

/* ---------- Kick off AFTER DOM ---------- */
document.addEventListener("DOMContentLoaded", loadFinancialData);
</script>

<body>

  <header>
    <div class="header-inner">
      <div>
        <h1>Alphen Peak</h1>
        <p>Accounting and financial systems support</p>
      </div>

      <nav>
        <a href="../index.html">Home</a>
        <a href="../services.html">Services</a>
        <a href="../about.html">About</a>
        <a href="../contact.html">Contact</a>
      </nav>
    </div>
  </header>

  <main>
    <h2>Financial Overview</h2>
    <p>
      Example management dashboard showing a high-level financial snapshot
      for a small business.
    </p>
    <div style="margin: 1.5rem 0;">
  <label for="monthFilter"><strong>Month:</strong></label>
  <select id="monthFilter">
    <option value="all">All months</option>
  </select>
</div>

    <div class="kpi-grid">
  <div class="kpi">
    <div class="kpi-label">Total Revenue</div>
    <div class="kpi-value" id="kpi-revenue">—</div>
  </div>

  <div class="kpi">
    <div class="kpi-label">Total Expenses</div>
    <div class="kpi-value" id="kpi-expenses">—</div>
  </div>

  <div class="kpi">
    <div class="kpi-label">Gross Profit</div>
    <div class="kpi-value" id="kpi-profit">—</div>
  </div>

  <div class="kpi">
    <div class="kpi-label">Gross Margin</div>
    <div class="kpi-value" id="kpi-margin">—</div>
  </div>
</div>


    <canvas id="revenueChart" height="120"></canvas>
  </main>

</body>
</html>
