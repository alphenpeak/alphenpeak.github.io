<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Financial Overview | Alphen Peak</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="../assets/css/styles.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
 
<body>

<header>
  <div class="header-inner">
    <div>
      <h1>Alphen Peak</h1>
      <p>Accounting and financial systems support</p>
    </div>

    <nav>
      <a href="../index.html">Home</a>
      <a href="../services.html">Services</a>
      <a href="../about.html">About</a>
      <a href="../contact.html">Contact</a>
    </nav>
  </div>
</header>

<main>
  <h2>Financial Overview</h2>
  <p>
    Example management dashboard showing a high-level financial snapshot
    for a small business.
  </p>

  <!-- Month Filter -->
 <div style="margin: 1.5rem 0; display: flex; gap: 1rem; align-items: center;">
  <label>
    From:
    <select id="fromMonth"></select>
  </label>

  <label>
    To:
    <select id="toMonth"></select>
  </label>
</div>


  <!-- KPIs -->
  <div class="kpi-grid">
    <div class="kpi">
      <div class="kpi-label">Total Revenue</div>
      <div class="kpi-value" id="kpi-revenue">—</div>
    </div>

    <div class="kpi">
      <div class="kpi-label">Total Expenses</div>
      <div class="kpi-value" id="kpi-expenses">—</div>
    </div>

    <div class="kpi">
      <div class="kpi-label">Gross Profit</div>
      <div class="kpi-value" id="kpi-profit">—</div>
    </div>

    <div class="kpi">
      <div class="kpi-label">Gross Margin</div>
      <div class="kpi-value" id="kpi-margin">—</div>
    </div>
  </div>

  <canvas id="revenueChart" height="120"></canvas>
</main>

<script>
document.addEventListener("DOMContentLoaded", loadFinancialData);

let fullData = [];
let chartInstance = null;

async function loadFinancialData() {
  const response = await fetch("data/financials.csv");
  const text = await response.text();

  const rows = text.trim().split("\n").slice(1);

  fullData = rows.map(row => {
    const [month, rev, exp] = row.split(",");
    return {
      month,
      revenue: Number(rev),
      expenses: Number(exp)
    };
  });

  populateRangeFilters();
  applyRangeFilter();
}

function populateRangeFilters() {
  const fromSelect = document.getElementById("fromMonth");
  const toSelect = document.getElementById("toMonth");

  fullData.forEach(d => {
    const optFrom = document.createElement("option");
    optFrom.value = d.month;
    optFrom.textContent = d.month;

    const optTo = optFrom.cloneNode(true);

    fromSelect.appendChild(optFrom);
    toSelect.appendChild(optTo);
  });

  // Default: full range
  fromSelect.selectedIndex = 0;
  toSelect.selectedIndex = fullData.length - 1;

  fromSelect.addEventListener("change", applyRangeFilter);
  toSelect.addEventListener("change", applyRangeFilter);
}

function applyRangeFilter() {
  const fromMonth = document.getElementById("fromMonth").value;
  const toMonth = document.getElementById("toMonth").value;

  const fromIndex = fullData.findIndex(d => d.month === fromMonth);
  const toIndex = fullData.findIndex(d => d.month === toMonth);

  if (fromIndex === -1 || toIndex === -1 || fromIndex > toIndex) {
    return; // invalid range, do nothing
  }

  const slice = fullData.slice(fromIndex, toIndex + 1);

  const labels = slice.map(d => d.month);
  const revenue = slice.map(d => d.revenue);
  const expenses = slice.map(d => d.expenses);

  const totalRevenue = revenue.reduce((a, b) => a + b, 0);
  const totalExpenses = expenses.reduce((a, b) => a + b, 0);

  updateKPIs(totalRevenue, totalExpenses);
  renderChart(labels, revenue, expenses);
}

function updateKPIs(totalRevenue, totalExpenses) {
  const profit = totalRevenue - totalExpenses;
  const margin = totalRevenue ? (profit / totalRevenue) * 100 : 0;

  document.getElementById("kpi-revenue").textContent =
    totalRevenue.toLocaleString("en-ZA", { style: "currency", currency: "ZAR" });

  document.getElementById("kpi-expenses").textContent =
    totalExpenses.toLocaleString("en-ZA", { style: "currency", currency: "ZAR" });

  document.getElementById("kpi-profit").textContent =
    profit.toLocaleString("en-ZA", { style: "currency", currency: "ZAR" });

  document.getElementById("kpi-margin").textContent =
    margin.toFixed(1) + "%";
}

function renderChart(labels, revenue, expenses) {
  const ctx = document.getElementById("revenueChart").getContext("2d");

  if (chartInstance) {
    chartInstance.destroy();
  }

  chartInstance = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "Revenue",
          data: revenue,
          borderColor: "#1f3a5f",
          backgroundColor: "transparent",
          pointBackgroundColor: "#1f3a5f",
          pointRadius: 4,
          fill: false,
          tension: 0.2
        },
        {
          label: "Expenses",
          data: expenses,
          borderColor: "#999",
          backgroundColor: "transparent",
          pointBackgroundColor: "#999",
          pointRadius: 4,
          fill: false,
          tension: 0.2
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: "bottom",
          labels: {
            usePointStyle: true,
            generateLabels: chart =>
              chart.data.datasets.map((ds, i) => ({
                text: ds.label,
                strokeStyle: ds.borderColor,
                fillStyle: ds.borderColor,
                lineWidth: 2,
                pointStyle: "line",
                hidden: !chart.isDatasetVisible(i),
                index: i
              }))
          }
        }
      }
    }
  });
}
</script>

</body>
</html>
